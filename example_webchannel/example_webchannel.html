<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Sapphire WebChannel ç¤ºä¾‹</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: "Microsoft YaHei", "Segoe UI", Arial, sans-serif;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: #333;
				padding: 20px;
				min-height: 100vh;
			}

			.container {
				max-width: 1200px;
				margin: 0 auto;
				background: rgba(255, 255, 255, 0.95);
				border-radius: 12px;
				padding: 30px;
				box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
			}

			h1 {
				color: #667eea;
				margin-bottom: 10px;
				font-size: 28px;
			}

			.subtitle {
				color: #666;
				margin-bottom: 30px;
				font-size: 14px;
			}

			.section {
				margin-bottom: 30px;
				padding: 20px;
				background: #f8f9fa;
				border-radius: 8px;
				border-left: 4px solid #667eea;
			}

			.section h2 {
				color: #333;
				margin-bottom: 15px;
				font-size: 20px;
			}

			.info-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
				gap: 15px;
				margin-bottom: 15px;
			}

			.info-item {
				background: white;
				padding: 12px;
				border-radius: 6px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			}

			.info-label {
				font-weight: bold;
				color: #667eea;
				font-size: 12px;
				margin-bottom: 5px;
			}

			.info-value {
				color: #333;
				font-size: 14px;
				word-break: break-all;
			}

			.button-group {
				display: flex;
				flex-wrap: wrap;
				gap: 10px;
				margin-top: 15px;
			}

			button {
				padding: 10px 20px;
				background: #667eea;
				color: white;
				border: none;
				border-radius: 6px;
				cursor: pointer;
				font-size: 14px;
				transition: all 0.3s;
			}

			button:hover {
				background: #5568d3;
				transform: translateY(-2px);
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
			}

			button:active {
				transform: translateY(0);
			}

			button:disabled {
				background: #ccc;
				cursor: not-allowed;
				transform: none;
			}

			.status {
				padding: 10px;
				border-radius: 6px;
				margin-top: 10px;
				font-size: 13px;
			}

			.status.success {
				background: #d4edda;
				color: #155724;
				border: 1px solid #c3e6cb;
			}

			.status.error {
				background: #f8d7da;
				color: #721c24;
				border: 1px solid #f5c6cb;
			}

			.status.info {
				background: #d1ecf1;
				color: #0c5460;
				border: 1px solid #bee5eb;
			}

			.log-area {
				background: #1e1e1e;
				color: #d4d4d4;
				padding: 15px;
				border-radius: 6px;
				font-family: "Consolas", "Monaco", monospace;
				font-size: 12px;
				max-height: 300px;
				overflow-y: auto;
				margin-top: 15px;
			}

			.log-entry {
				margin-bottom: 5px;
				padding: 3px 0;
			}

			.log-entry.info {
				color: #4ec9b0;
			}

			.log-entry.error {
				color: #f48771;
			}

			.log-entry.success {
				color: #89d185;
			}

			.smtc-controls {
				display: flex;
				gap: 10px;
				flex-wrap: wrap;
			}

			.smtc-info {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 10px;
				margin-top: 15px;
			}

			.album-art {
				width: 150px;
				height: 150px;
				border-radius: 8px;
				object-fit: cover;
				background: #ddd;
				display: block;
				margin: 10px auto;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>ğŸµ Sapphire WebChannel äº¤äº’ç¤ºä¾‹</h1>
			<p class="subtitle">å±•ç¤ºå¦‚ä½•é€šè¿‡WebChannelä¸Qt C++ç«¯è¿›è¡ŒåŒå‘é€šä¿¡</p>

			<!-- WebChannelè¿æ¥çŠ¶æ€ -->
			<div class="section">
				<h2>ğŸ“¡ WebChannel è¿æ¥çŠ¶æ€</h2>
				<div id="connectionStatus" class="status info">
					æ­£åœ¨åˆå§‹åŒ–WebChannel...
				</div>
				<div class="button-group">
					<button onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
					<button onclick="getCurrentTime()">è·å–å½“å‰æ—¶é—´</button>
					<button onclick="getThemeColor()">è·å–ä¸»é¢˜è‰²</button>
				</div>
			</div>

			<!-- UnitåŸºç¡€ä¿¡æ¯ -->
			<div class="section">
				<h2>ğŸ“¦ Unit åŸºç¡€ä¿¡æ¯</h2>
				<div class="info-grid" id="unitInfoGrid">
					<div class="info-item">
						<div class="info-label">å°ç»„ä»¶åç§°</div>
						<div class="info-value" id="widgetName">-</div>
					</div>
					<div class="info-item">
						<div class="info-label">å°ç»„ä»¶ç±»å‹</div>
						<div class="info-value" id="widgetType">-</div>
					</div>
					<div class="info-item">
						<div class="info-label">ç„¦ç‚¹çŠ¶æ€</div>
						<div class="info-value" id="isFocus">-</div>
					</div>
					<div class="info-item">
						<div class="info-label">é€‰ä¸­çŠ¶æ€</div>
						<div class="info-value" id="isSelect">-</div>
					</div>
					<div class="info-item">
						<div class="info-label">å¤§å° (X Ã— Y)</div>
						<div class="info-value" id="size">-</div>
					</div>
					<div class="info-item">
						<div class="info-label">å¯è§æ€§</div>
						<div class="info-value" id="isVisible">-</div>
					</div>
				</div>
				<div class="button-group">
					<button onclick="loadUnitInfo()">åˆ·æ–°Unitä¿¡æ¯</button>
					<button onclick="getWidgetProperty('isFocus')">è·å–ç„¦ç‚¹å±æ€§</button>
					<button onclick="getWidgetProperty('sizeX')">è·å–å®½åº¦</button>
				</div>
			</div>

			<!-- SMTCåª’ä½“ä¿¡æ¯ -->
			<div class="section">
				<h2>ğŸµ SMTC åª’ä½“ä¿¡æ¯</h2>
				<div id="smtcStatus" class="status info">SMTCåŠŸèƒ½çŠ¶æ€ï¼šæ£€æŸ¥ä¸­...</div>
				<!-- ä¸“è¾‘å°é¢ -->
				<div style="text-align: center; margin-bottom: 15px">
					<img
						id="albumArtImage"
						class="album-art"
						src=""
						alt="ä¸“è¾‘å°é¢"
						style="display: none"
					/>
				</div>
				<div class="smtc-info" id="smtcMediaInfo">
					<div class="info-item">
						<div class="info-label">åª’ä½“æ ‡é¢˜</div>
						<div class="info-value" id="mediaTitle">-</div>
					</div>
					<div class="info-item">
						<div class="info-label">è‰ºæœ¯å®¶</div>
						<div class="info-value" id="mediaArtist">-</div>
					</div>
					<div class="info-item">
						<div class="info-label">ä¸“è¾‘</div>
						<div class="info-value" id="mediaAlbum">-</div>
					</div>
					<div class="info-item">
						<div class="info-label">åº”ç”¨åç§°</div>
						<div class="info-value" id="appName">-</div>
					</div>
					<div class="info-item">
						<div class="info-label">æ’­æ”¾çŠ¶æ€</div>
						<div class="info-value" id="playbackStatus">-</div>
					</div>
					<div class="info-item">
						<div class="info-label">æ’­æ”¾è¿›åº¦</div>
						<div class="info-value" id="playbackProgress">-</div>
					</div>
				</div>
				<div class="button-group">
					<button onclick="loadSMTCMediaInfo()">åˆ·æ–°åª’ä½“ä¿¡æ¯</button>
					<button onclick="loadSMTCPlaybackStatus()">åˆ·æ–°æ’­æ”¾çŠ¶æ€</button>
					<button onclick="loadSMTCControlCapabilities()">åˆ·æ–°æ§åˆ¶èƒ½åŠ›</button>
				</div>
			</div>

			<!-- SMTCæ§åˆ¶ -->
			<div class="section">
				<h2>ğŸ® SMTC åª’ä½“æ§åˆ¶</h2>
				<div id="controlStatus" class="status info">ç­‰å¾…åŠ è½½æ§åˆ¶èƒ½åŠ›...</div>
				<div class="smtc-controls" id="smtcControls">
					<button onclick="controlSMTC('play')" id="btnPlay" disabled>
						æ’­æ”¾
					</button>
					<button onclick="controlSMTC('pause')" id="btnPause" disabled>
						æš‚åœ
					</button>
					<button onclick="controlSMTC('stop')" id="btnStop" disabled>
						åœæ­¢
					</button>
					<button onclick="controlSMTC('next')" id="btnNext" disabled>
						ä¸‹ä¸€é¦–
					</button>
					<button onclick="controlSMTC('previous')" id="btnPrevious" disabled>
						ä¸Šä¸€é¦–
					</button>
				</div>
			</div>

			<!-- æ—¥å¿—åŒºåŸŸ -->
			<div class="section">
				<h2>ğŸ“‹ æ“ä½œæ—¥å¿—</h2>
				<div class="button-group">
					<button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
					<button onclick="testSignalConnection()">æµ‹è¯•ä¿¡å·è¿æ¥</button>
				</div>
				<div class="log-area" id="logArea"></div>
			</div>
		</div>

		<!-- åŠ è½½qwebchannel.js -->
		<script src="qrc:///qtwebchannel/qwebchannel.js"></script>
		<script>
			// WebChannelå’Œbridgeå¯¹è±¡
			let channel = null;
			let bridge = null;

			// æ—¥å¿—å‡½æ•°
			function log(message, type = "info") {
				const logArea = document.getElementById("logArea");
				const entry = document.createElement("div");
				entry.className = `log-entry ${type}`;
				entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
				logArea.appendChild(entry);
				logArea.scrollTop = logArea.scrollHeight;
				console.log(message);
			}

			function clearLog() {
				document.getElementById("logArea").innerHTML = "";
			}

			// åˆå§‹åŒ–WebChannel
			function initWebChannel() {
				log("æ­£åœ¨åˆå§‹åŒ–WebChannel...", "info");

				// åˆ›å»ºtransportå¯¹è±¡ï¼ˆå¯¹äºWebEngineViewï¼Œä½¿ç”¨qt.webChannelTransportï¼‰
				if (typeof qt === "undefined" || !qt.webChannelTransport) {
					log("é”™è¯¯: qt.webChannelTransport ä¸å¯ç”¨", "error");
					document.getElementById("connectionStatus").textContent =
						"âŒ WebChannelåˆå§‹åŒ–å¤±è´¥: qt.webChannelTransportä¸å¯ç”¨";
					document.getElementById("connectionStatus").className =
						"status error";
					return;
				}

				// åˆ›å»ºQWebChannelå®ä¾‹
				new QWebChannel(qt.webChannelTransport, function (ch) {
					channel = ch;
					bridge = channel.objects.bridge;

					if (!bridge) {
						log("é”™è¯¯: bridgeå¯¹è±¡æœªæ‰¾åˆ°", "error");
						document.getElementById("connectionStatus").textContent =
							"âŒ Bridgeå¯¹è±¡æœªæ‰¾åˆ°";
						document.getElementById("connectionStatus").className =
							"status error";
						return;
					}

					log("âœ… WebChannelåˆå§‹åŒ–æˆåŠŸï¼Œbridgeå¯¹è±¡å¯ç”¨", "success");
					document.getElementById("connectionStatus").textContent =
						"âœ… WebChannelå·²è¿æ¥ï¼Œbridgeå¯¹è±¡å¯ç”¨ï¼ˆå“åº”å¼å±æ€§å·²å¯ç”¨ï¼‰";
					document.getElementById("connectionStatus").className =
						"status success";

					// è¿æ¥ä¿¡å·
					if (bridge.messageReceived) {
						bridge.messageReceived.connect(function (message) {
							log(`æ”¶åˆ°C++æ¶ˆæ¯: ${message}`, "info");
						});
					}

					if (bridge.functionCalled) {
						bridge.functionCalled.connect(function (functionName, parameters) {
							log(`C++å‡½æ•°è°ƒç”¨: ${functionName}(${parameters})`, "info");
						});
					}

					// ==================== å“åº”å¼å±æ€§ç»‘å®š ====================
					// è¿æ¥å“åº”å¼å±æ€§å˜åŒ–ä¿¡å·ï¼Œå½“C++ç«¯æ•°æ®å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°UI
					// è¿™æ˜¯å“åº”å¼æ›´æ–°çš„å…³é”®ï¼šä¸éœ€è¦JSä¸»åŠ¨è½®è¯¢ï¼ŒC++ç«¯å˜åŒ–æ—¶è‡ªåŠ¨é€šçŸ¥JS

					if (bridge.smtcMediaInfoChanged) {
						bridge.smtcMediaInfoChanged.connect(function () {
							log("ğŸ”„ SMTCåª’ä½“ä¿¡æ¯å·²æ›´æ–°ï¼ˆå“åº”å¼ï¼‰", "info");
							updateSMTCMediaInfoFromProperty();
						});
					}

					if (bridge.smtcPlaybackStatusChanged) {
						bridge.smtcPlaybackStatusChanged.connect(function () {
							log("ğŸ”„ SMTCæ’­æ”¾çŠ¶æ€å·²æ›´æ–°ï¼ˆå“åº”å¼ï¼‰", "info");
							updateSMTCPlaybackStatusFromProperty();
						});
					}

					if (bridge.smtcControlCapabilitiesChanged) {
						bridge.smtcControlCapabilitiesChanged.connect(function () {
							log("ğŸ”„ SMTCæ§åˆ¶èƒ½åŠ›å·²æ›´æ–°ï¼ˆå“åº”å¼ï¼‰", "info");
							updateSMTCControlCapabilitiesFromProperty();
						});
					}

					if (bridge.unitInfoChanged) {
						bridge.unitInfoChanged.connect(function () {
							log("ğŸ”„ å°ç»„ä»¶åŸºç¡€ä¿¡æ¯å·²æ›´æ–°ï¼ˆå“åº”å¼ï¼‰", "info");
							updateUnitInfoFromProperty();
						});
					}

					// å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿C++ç«¯å±æ€§å·²å‡†å¤‡å¥½ï¼ˆå‚ç…§QMLå®ç°ï¼‰
					// ä½¿ç”¨setTimeoutç¡®ä¿bridgeå¯¹è±¡å®Œå…¨åˆå§‹åŒ–åå†è¯»å–å±æ€§
					setTimeout(function () {
						// åˆå§‹åŒ–æ—¶åŠ è½½ä¸€æ¬¡æ•°æ®ï¼ˆä½¿ç”¨å“åº”å¼å±æ€§ï¼‰
						updateUnitInfoFromProperty();
						updateSMTCMediaInfoFromProperty();
						updateSMTCPlaybackStatusFromProperty();
						updateSMTCControlCapabilitiesFromProperty();

						log("âœ… å“åº”å¼å±æ€§åˆå§‹åŒ–å®Œæˆï¼Œæ•°æ®å°†è‡ªåŠ¨åŒæ­¥", "success");
					}, 200); // å»¶è¿Ÿ200msç¡®ä¿C++ç«¯å±æ€§å·²åˆå§‹åŒ–

					log("âœ… å“åº”å¼å±æ€§ç»‘å®šå·²å®Œæˆï¼Œæ•°æ®å°†è‡ªåŠ¨åŒæ­¥", "success");
				});
			}

			// æµ‹è¯•è¿æ¥
			function testConnection() {
				if (!bridge) {
					log("é”™è¯¯: bridgeå¯¹è±¡æœªåˆå§‹åŒ–", "error");
					return;
				}
				log("æµ‹è¯•è¿æ¥ä¸­...", "info");
				bridge.post("Hello from HTML!");
			}

			// è·å–å½“å‰æ—¶é—´
			function getCurrentTime() {
				if (!bridge) {
					log("é”™è¯¯: bridgeå¯¹è±¡æœªåˆå§‹åŒ–", "error");
					return;
				}
				// QWebChannelçš„æ–¹æ³•è°ƒç”¨æ˜¯å¼‚æ­¥çš„ï¼Œæœ€åä¸€ä¸ªå‚æ•°æ˜¯å›è°ƒå‡½æ•°
				bridge.getCurrentTime(function (time) {
					log(`å½“å‰æ—¶é—´: ${time}`, "success");
					alert(`å½“å‰æ—¶é—´: ${time}`);
				});
			}

			// è·å–ä¸»é¢˜è‰²
			function getThemeColor() {
				if (!bridge) {
					log("é”™è¯¯: bridgeå¯¹è±¡æœªåˆå§‹åŒ–", "error");
					return;
				}
				bridge.getThemeColor(function (color) {
					log(`ä¸»é¢˜è‰²: ${color}`, "success");
					document.body.style.setProperty("--theme-color", color);
					alert(`ä¸»é¢˜è‰²: ${color}`);
				});
			}

			// åŠ è½½UnitåŸºç¡€ä¿¡æ¯ï¼ˆä¸»åŠ¨è·å–æ–¹å¼ï¼Œä¿ç•™ç”¨äºå…¼å®¹ï¼‰
			function loadUnitInfo() {
				if (!bridge) {
					log("é”™è¯¯: bridgeå¯¹è±¡æœªåˆå§‹åŒ–", "error");
					return;
				}
				log("æ­£åœ¨åŠ è½½UnitåŸºç¡€ä¿¡æ¯ï¼ˆä¸»åŠ¨è·å–ï¼‰...", "info");
				// QWebChannelçš„æ–¹æ³•è°ƒç”¨ï¼šæœ€åä¸€ä¸ªå‚æ•°æ˜¯å›è°ƒå‡½æ•°ï¼Œæ¥æ”¶è¿”å›å€¼
				bridge.getUnitInfo(function (jsonStr) {
					try {
						const info = JSON.parse(jsonStr);
						updateUnitInfoUI(info);
						log("âœ… UnitåŸºç¡€ä¿¡æ¯åŠ è½½æˆåŠŸï¼ˆä¸»åŠ¨è·å–ï¼‰", "success");
					} catch (e) {
						log(`é”™è¯¯: è§£æUnitä¿¡æ¯å¤±è´¥ - ${e.message}`, "error");
					}
				});
			}

			// ä»å“åº”å¼å±æ€§æ›´æ–°UnitåŸºç¡€ä¿¡æ¯ï¼ˆæ¨èæ–¹å¼ï¼‰
			function updateUnitInfoFromProperty() {
				if (!bridge || !bridge.unitInfo) {
					return;
				}
				try {
					const info = JSON.parse(bridge.unitInfo);
					updateUnitInfoUI(info);
				} catch (e) {
					log(`é”™è¯¯: è§£æUnitä¿¡æ¯å¤±è´¥ - ${e.message}`, "error");
				}
			}

			// æ›´æ–°UnitåŸºç¡€ä¿¡æ¯UIï¼ˆå…¬å…±æ–¹æ³•ï¼‰
			function updateUnitInfoUI(info) {
				document.getElementById("widgetName").textContent =
					info.widgetName || "-";
				document.getElementById("widgetType").textContent = getWidgetTypeName(
					info.widgetType
				);
				document.getElementById("isFocus").textContent = info.isFocus
					? "æ˜¯"
					: "å¦";
				document.getElementById("isSelect").textContent = info.isSelect
					? "æ˜¯"
					: "å¦";
				document.getElementById(
					"size"
				).textContent = `${info.sizeX} Ã— ${info.sizeY}`;
				document.getElementById("isVisible").textContent = info.isVisible
					? "æ˜¯"
					: "å¦";
			}

			// è·å–å°ç»„ä»¶ç±»å‹åç§°
			function getWidgetTypeName(type) {
				const types = {
					0: "HTML",
					1: "QML",
					2: "URL",
					3: "Unknown",
				};
				return types[type] || "Unknown";
			}

			// è·å–å°ç»„ä»¶å±æ€§
			function getWidgetProperty(propertyName) {
				if (!bridge) {
					log("é”™è¯¯: bridgeå¯¹è±¡æœªåˆå§‹åŒ–", "error");
					return;
				}
				log(`æ­£åœ¨è·å–å±æ€§: ${propertyName}...`, "info");
				// QWebChannelæ–¹æ³•è°ƒç”¨ï¼šå‚æ•°1æ˜¯å±æ€§åï¼Œå‚æ•°2æ˜¯å›è°ƒå‡½æ•°
				bridge.getWidgetProperty(propertyName, function (jsonStr) {
					try {
						const result = JSON.parse(jsonStr);
						log(
							`å±æ€§ ${propertyName} = ${JSON.stringify(result.value)}`,
							"success"
						);
						alert(`${propertyName}: ${JSON.stringify(result.value)}`);
					} catch (e) {
						log(`é”™è¯¯: è§£æå±æ€§å¤±è´¥ - ${e.message}`, "error");
					}
				});
			}

			// åŠ è½½SMTCåª’ä½“ä¿¡æ¯ï¼ˆä¸»åŠ¨è·å–æ–¹å¼ï¼Œä¿ç•™ç”¨äºå…¼å®¹ï¼‰
			function loadSMTCMediaInfo() {
				if (!bridge) {
					log("é”™è¯¯: bridgeå¯¹è±¡æœªåˆå§‹åŒ–", "error");
					return;
				}
				log("æ­£åœ¨åŠ è½½SMTCåª’ä½“ä¿¡æ¯ï¼ˆä¸»åŠ¨è·å–ï¼‰...", "info");
				bridge.getSMTCMediaInfo(function (jsonStr) {
					try {
						const info = JSON.parse(jsonStr);
						updateSMTCMediaInfoUI(info);
						log("âœ… SMTCåª’ä½“ä¿¡æ¯åŠ è½½æˆåŠŸï¼ˆä¸»åŠ¨è·å–ï¼‰", "success");
					} catch (e) {
						log(`é”™è¯¯: è§£æSMTCåª’ä½“ä¿¡æ¯å¤±è´¥ - ${e.message}`, "error");
					}
				});
			}

			// ä»å“åº”å¼å±æ€§æ›´æ–°SMTCåª’ä½“ä¿¡æ¯ï¼ˆæ¨èæ–¹å¼ï¼‰
			function updateSMTCMediaInfoFromProperty() {
				if (!bridge || !bridge.smtcMediaInfo) {
					return;
				}
				try {
					const info = JSON.parse(bridge.smtcMediaInfo);
					updateSMTCMediaInfoUI(info);
				} catch (e) {
					log(`é”™è¯¯: è§£æSMTCåª’ä½“ä¿¡æ¯å¤±è´¥ - ${e.message}`, "error");
				}
			}

			// æ›´æ–°SMTCåª’ä½“ä¿¡æ¯UIï¼ˆå…¬å…±æ–¹æ³•ï¼‰
			function updateSMTCMediaInfoUI(info) {
				if (!info.enabled) {
					document.getElementById("smtcStatus").textContent =
						"âŒ SMTCåŠŸèƒ½æœªå¯ç”¨";
					document.getElementById("smtcStatus").className = "status error";
					// éšè—ä¸“è¾‘å°é¢
					document.getElementById("albumArtImage").style.display = "none";
					return;
				}
				document.getElementById("smtcStatus").textContent =
					"âœ… SMTCåŠŸèƒ½å·²å¯ç”¨ï¼ˆå“åº”å¼ï¼‰";
				document.getElementById("smtcStatus").className = "status success";
				document.getElementById("mediaTitle").textContent =
					info.mediaTitle || "-";
				document.getElementById("mediaArtist").textContent =
					info.mediaArtist || "-";
				document.getElementById("mediaAlbum").textContent =
					info.mediaAlbum || "-";
				document.getElementById("appName").textContent = info.appName || "-";
				document.getElementById("playbackStatus").textContent =
					info.playbackStatus || "-";

				// æ›´æ–°ä¸“è¾‘å°é¢ï¼ˆå‚ç…§QMLå®ç°ï¼‰
				const albumArtImg = document.getElementById("albumArtImage");
				if (info.hasAlbumArt && info.albumArtBase64) {
					albumArtImg.src = "data:image/jpeg;base64," + info.albumArtBase64;
					albumArtImg.style.display = "block";
					albumArtImg.alt = info.mediaAlbum || "ä¸“è¾‘å°é¢";
					if (info.albumArtSize) {
						albumArtImg.title = "å°ºå¯¸: " + info.albumArtSize;
					}
				} else {
					albumArtImg.style.display = "none";
				}
			}

			// åŠ è½½SMTCæ’­æ”¾çŠ¶æ€ï¼ˆä¸»åŠ¨è·å–æ–¹å¼ï¼Œä¿ç•™ç”¨äºå…¼å®¹ï¼‰
			function loadSMTCPlaybackStatus() {
				if (!bridge) {
					log("é”™è¯¯: bridgeå¯¹è±¡æœªåˆå§‹åŒ–", "error");
					return;
				}
				log("æ­£åœ¨åŠ è½½SMTCæ’­æ”¾çŠ¶æ€ï¼ˆä¸»åŠ¨è·å–ï¼‰...", "info");
				bridge.getSMTCPlaybackStatus(function (jsonStr) {
					try {
						const status = JSON.parse(jsonStr);
						updateSMTCPlaybackStatusUI(status);
						log("âœ… SMTCæ’­æ”¾çŠ¶æ€åŠ è½½æˆåŠŸï¼ˆä¸»åŠ¨è·å–ï¼‰", "success");
					} catch (e) {
						log(`é”™è¯¯: è§£æSMTCæ’­æ”¾çŠ¶æ€å¤±è´¥ - ${e.message}`, "error");
					}
				});
			}

			// ä»å“åº”å¼å±æ€§æ›´æ–°SMTCæ’­æ”¾çŠ¶æ€ï¼ˆæ¨èæ–¹å¼ï¼‰
			function updateSMTCPlaybackStatusFromProperty() {
				if (!bridge || !bridge.smtcPlaybackStatus) {
					return;
				}
				try {
					const status = JSON.parse(bridge.smtcPlaybackStatus);
					updateSMTCPlaybackStatusUI(status);
				} catch (e) {
					log(`é”™è¯¯: è§£æSMTCæ’­æ”¾çŠ¶æ€å¤±è´¥ - ${e.message}`, "error");
				}
			}

			// æ›´æ–°SMTCæ’­æ”¾çŠ¶æ€UIï¼ˆå…¬å…±æ–¹æ³•ï¼‰
			function updateSMTCPlaybackStatusUI(status) {
				if (!status.enabled) {
					return;
				}
				document.getElementById("playbackStatus").textContent =
					status.playbackStatus || "-";
				document.getElementById("playbackProgress").textContent = `${
					status.playbackProgress
				}% (${formatTime(status.playbackPosition)} / ${formatTime(
					status.playbackDuration
				)})`;
			}

			// åŠ è½½SMTCæ§åˆ¶èƒ½åŠ›ï¼ˆä¸»åŠ¨è·å–æ–¹å¼ï¼Œä¿ç•™ç”¨äºå…¼å®¹ï¼‰
			function loadSMTCControlCapabilities() {
				if (!bridge) {
					log("é”™è¯¯: bridgeå¯¹è±¡æœªåˆå§‹åŒ–", "error");
					return;
				}
				log("æ­£åœ¨åŠ è½½SMTCæ§åˆ¶èƒ½åŠ›ï¼ˆä¸»åŠ¨è·å–ï¼‰...", "info");
				bridge.getSMTCControlCapabilities(function (jsonStr) {
					try {
						const capabilities = JSON.parse(jsonStr);
						updateSMTCControlCapabilitiesUI(capabilities);
						log("âœ… SMTCæ§åˆ¶èƒ½åŠ›åŠ è½½æˆåŠŸï¼ˆä¸»åŠ¨è·å–ï¼‰", "success");
					} catch (e) {
						log(`é”™è¯¯: è§£æSMTCæ§åˆ¶èƒ½åŠ›å¤±è´¥ - ${e.message}`, "error");
					}
				});
			}

			// ä»å“åº”å¼å±æ€§æ›´æ–°SMTCæ§åˆ¶èƒ½åŠ›ï¼ˆæ¨èæ–¹å¼ï¼‰
			function updateSMTCControlCapabilitiesFromProperty() {
				if (!bridge || !bridge.smtcControlCapabilities) {
					return;
				}
				try {
					const capabilities = JSON.parse(bridge.smtcControlCapabilities);
					updateSMTCControlCapabilitiesUI(capabilities);
				} catch (e) {
					log(`é”™è¯¯: è§£æSMTCæ§åˆ¶èƒ½åŠ›å¤±è´¥ - ${e.message}`, "error");
				}
			}

			// æ›´æ–°SMTCæ§åˆ¶èƒ½åŠ›UIï¼ˆå…¬å…±æ–¹æ³•ï¼‰
			function updateSMTCControlCapabilitiesUI(capabilities) {
				if (!capabilities.enabled) {
					document.getElementById("controlStatus").textContent =
						"âŒ SMTCåŠŸèƒ½æœªå¯ç”¨";
					document.getElementById("controlStatus").className = "status error";
					return;
				}
				document.getElementById("controlStatus").textContent =
					"âœ… SMTCæ§åˆ¶å¯ç”¨ï¼ˆå“åº”å¼ï¼‰";
				document.getElementById("controlStatus").className = "status success";
				document.getElementById("btnPlay").disabled = !capabilities.canPlay;
				document.getElementById("btnPause").disabled = !capabilities.canPause;
				document.getElementById("btnStop").disabled = !capabilities.canStop;
				document.getElementById("btnNext").disabled = !capabilities.canSkipNext;
				document.getElementById("btnPrevious").disabled =
					!capabilities.canSkipPrevious;
			}

			// æ§åˆ¶SMTC
			function controlSMTC(action) {
				if (!bridge) {
					log("é”™è¯¯: bridgeå¯¹è±¡æœªåˆå§‹åŒ–", "error");
					return;
				}
				log(`æ­£åœ¨æ‰§è¡ŒSMTCæ§åˆ¶: ${action}...`, "info");

				// æ ¹æ®æ“ä½œç±»å‹è°ƒç”¨ä¸åŒçš„æ–¹æ³•
				let methodName = "";
				switch (action) {
					case "play":
						methodName = "playSMTCMedia";
						break;
					case "pause":
						methodName = "pauseSMTCMedia";
						break;
					case "stop":
						methodName = "stopSMTCMedia";
						break;
					case "next":
						methodName = "skipSMTCNext";
						break;
					case "previous":
						methodName = "skipSMTCPrevious";
						break;
					default:
						log(`é”™è¯¯: æœªçŸ¥çš„SMTCæ“ä½œ: ${action}`, "error");
						return;
				}

				// è°ƒç”¨bridgeæ–¹æ³•ï¼Œæœ€åä¸€ä¸ªå‚æ•°æ˜¯å›è°ƒå‡½æ•°
				if (bridge[methodName]) {
					bridge[methodName](function (success) {
						if (success) {
							log(`âœ… SMTCæ§åˆ¶æˆåŠŸ: ${action}`, "success");
						} else {
							log(`âŒ SMTCæ§åˆ¶å¤±è´¥: ${action}`, "error");
						}
					});
				} else {
					log(`é”™è¯¯: bridgeå¯¹è±¡æ²¡æœ‰${methodName}æ–¹æ³•`, "error");
				}
			}

			// æ ¼å¼åŒ–æ—¶é—´ï¼ˆæ¯«ç§’è½¬MM:SSï¼‰
			function formatTime(ms) {
				if (!ms || ms < 0) return "00:00";
				const totalSeconds = Math.floor(ms / 1000);
				const minutes = Math.floor(totalSeconds / 60);
				const seconds = totalSeconds % 60;
				return `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(
					2,
					"0"
				)}`;
			}

			// æµ‹è¯•ä¿¡å·è¿æ¥
			function testSignalConnection() {
				if (!bridge) {
					log("é”™è¯¯: bridgeå¯¹è±¡æœªåˆå§‹åŒ–", "error");
					return;
				}
				log("æµ‹è¯•ä¿¡å·è¿æ¥...", "info");
				if (bridge.messageReceived) {
					log("âœ… messageReceivedä¿¡å·å·²è¿æ¥", "success");
				} else {
					log("âŒ messageReceivedä¿¡å·æœªæ‰¾åˆ°", "error");
				}
			}

			// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–WebChannel
			window.addEventListener("DOMContentLoaded", function () {
				log("é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–WebChannel...", "info");
				// å»¶è¿Ÿä¸€ä¸‹ç¡®ä¿qtå¯¹è±¡å·²å‡†å¤‡å¥½
				setTimeout(initWebChannel, 100);
			});

			// æ³¨æ„ï¼šä½¿ç”¨å“åº”å¼å±æ€§åï¼Œä¸å†éœ€è¦å®šæœŸè½®è¯¢
			// æ•°æ®å˜åŒ–æ—¶ä¼šè‡ªåŠ¨é€šè¿‡ä¿¡å·é€šçŸ¥ï¼Œæ— éœ€å®šæ—¶åˆ·æ–°
			// ä»¥ä¸‹ä»£ç å·²æ³¨é‡Šï¼Œä»…ä½œä¸ºå¯¹æ¯”ç¤ºä¾‹
			// setInterval(function () {
			// 	if (bridge) {
			// 		loadSMTCPlaybackStatus(); // ä¸»åŠ¨è·å–æ–¹å¼
			// 	}
			// }, 2000); // æ¯2ç§’åˆ·æ–°ä¸€æ¬¡æ’­æ”¾çŠ¶æ€
		</script>
	</body>
</html>
