<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>ProxyFileåŠŸèƒ½æ¼”ç¤º</title>
		<script src="qrc:///qtwebchannel/qwebchannel.js"></script>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: "Microsoft YaHei", "Segoe UI", Arial, sans-serif;
				background: transparent;
				color: #ffffff;
				overflow: hidden;
				width: 100%;
				height: 100%;
			}

			.container {
				width: 100%;
				height: 100%;
				display: flex;
				flex-direction: column;
				padding: 16px;
				background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
				border-radius: 12px;
			}

			.header {
				margin-bottom: 16px;
			}

			.title {
				font-size: 20px;
				font-weight: bold;
				color: #ffffff;
				margin-bottom: 8px;
			}

			.subtitle {
				font-size: 12px;
				color: #aaaaaa;
			}

			.file-info {
				flex: 1;
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				padding: 24px;
				background: rgba(255, 255, 255, 0.05);
				border-radius: 8px;
				margin-bottom: 16px;
				min-height: 200px;
			}

			.file-icon {
				width: 80px;
				height: 80px;
				border-radius: 12px;
				margin-bottom: 16px;
				background: rgba(255, 255, 255, 0.1);
				display: flex;
				align-items: center;
				justify-content: center;
				overflow: hidden;
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
			}

			.file-icon img {
				width: 100%;
				height: 100%;
				object-fit: contain;
			}

			.file-icon-placeholder {
				font-size: 40px;
			}

			.file-name {
				font-size: 18px;
				font-weight: bold;
				color: #ffffff;
				margin-bottom: 8px;
				text-align: center;
				word-break: break-all;
			}

			.file-path {
				font-size: 12px;
				color: #aaaaaa;
				text-align: center;
				word-break: break-all;
				margin-bottom: 16px;
			}

			.file-color {
				width: 40px;
				height: 40px;
				border-radius: 8px;
				margin: 8px auto;
				border: 2px solid rgba(255, 255, 255, 0.3);
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
			}

			.no-file {
				text-align: center;
				color: #888888;
				font-size: 14px;
			}

			.no-file-icon {
				font-size: 48px;
				margin-bottom: 12px;
			}

			.buttons {
				display: flex;
				gap: 8px;
				flex-wrap: wrap;
			}

			.btn {
				flex: 1;
				min-width: 100px;
				padding: 10px 16px;
				background: rgba(0, 122, 204, 0.8);
				color: #ffffff;
				border: none;
				border-radius: 6px;
				font-size: 14px;
				font-weight: 500;
				cursor: pointer;
				transition: all 0.3s ease;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
			}

			.btn:hover {
				background: rgba(0, 122, 204, 1);
				transform: translateY(-2px);
				box-shadow: 0 4px 12px rgba(0, 122, 204, 0.4);
			}

			.btn:active {
				transform: translateY(0);
			}

			.btn:disabled {
				background: rgba(255, 255, 255, 0.1);
				color: #666666;
				cursor: not-allowed;
				transform: none;
			}

			.btn-secondary {
				background: rgba(255, 255, 255, 0.1);
			}

			.btn-secondary:hover {
				background: rgba(255, 255, 255, 0.2);
			}

			.status {
				margin-top: 12px;
				padding: 8px 12px;
				background: rgba(0, 122, 204, 0.2);
				border-radius: 6px;
				font-size: 12px;
				color: #aaaaaa;
				text-align: center;
			}

			.status.success {
				background: rgba(0, 200, 100, 0.2);
				color: #4caf50;
			}

			.status.error {
				background: rgba(255, 100, 100, 0.2);
				color: #f44336;
			}

			@keyframes fadeIn {
				from {
					opacity: 0;
					transform: translateY(-10px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			.file-info {
				animation: fadeIn 0.3s ease;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="header">
				<div class="title">ProxyFileåŠŸèƒ½æ¼”ç¤º</div>
				<div class="subtitle">å±•ç¤ºæ–‡ä»¶ä»£ç†æ•°æ®è·å–å’Œæ–‡ä»¶æ“ä½œæ¥å£</div>
			</div>

			<div class="file-info" id="fileInfo">
				<div class="no-file" id="noFile">
					<div class="no-file-icon">ğŸ“„</div>
					<div>æœªé€‰æ‹©æ–‡ä»¶</div>
					<div style="font-size: 11px; margin-top: 8px; color: #666">
						å³é”®ç‚¹å‡»å°ç»„ä»¶é€‰æ‹©æ–‡ä»¶
					</div>
				</div>

				<div id="fileContent" style="display: none; width: 100%">
					<div class="file-icon" id="fileIcon">
						<div class="file-icon-placeholder">ğŸ“„</div>
					</div>
					<div class="file-name" id="fileName">-</div>
					<div class="file-path" id="filePath">-</div>
					<div class="file-color" id="fileColor"></div>
				</div>
			</div>

			<div class="buttons">
				<button class="btn" id="openFileBtn" onclick="openFile()" disabled>
					æ‰“å¼€æ–‡ä»¶
				</button>
				<button
					class="btn btn-secondary"
					id="openLocationBtn"
					onclick="openLocation()"
					disabled
				>
					æ‰“å¼€ä½ç½®
				</button>
				<button
					class="btn btn-secondary"
					id="openPropertyBtn"
					onclick="openProperty()"
					disabled
				>
					æ–‡ä»¶å±æ€§
				</button>
				<button
					class="btn btn-secondary"
					id="removeFileBtn"
					onclick="removeFile()"
					disabled
				>
					ç§»é™¤æ–‡ä»¶
				</button>
			</div>

			<div class="status" id="status"></div>
		</div>

		<script>
			let bridge = null;
			let currentFilePath = "";

			// åˆå§‹åŒ–WebChannel
			new QWebChannel(qt.webChannelTransport, function (channel) {
				bridge = channel.objects.bridge;

				if (!bridge) {
					console.error("æ— æ³•è·å–bridgeå¯¹è±¡");
					showStatus("é”™è¯¯: æ— æ³•è¿æ¥åˆ°C++ç«¯", "error");
					return;
				}

				console.log("WebChannelè¿æ¥æˆåŠŸ");
				showStatus("å·²è¿æ¥åˆ°C++ç«¯", "success");

				// è¿æ¥å“åº”å¼å±æ€§å˜åŒ–ä¿¡å·
				bridge.proxyFilePathChanged.connect(function () {
					updateFileInfo();
				});

				bridge.proxyFileRemoved.connect(function () {
					console.log("ä»£ç†æ–‡ä»¶è¢«åˆ é™¤");
					showStatus("æ–‡ä»¶å·²è¢«åˆ é™¤", "error");
					clearFileInfo();
				});

				// åˆå§‹åŒ–æ—¶æ›´æ–°æ–‡ä»¶ä¿¡æ¯
				updateFileInfo();
			});

			/**
			 * æ›´æ–°æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º
			 */
			async function updateFileInfo() {
				if (!bridge) {
					return;
				}

				try {
					const filePath = bridge.proxyFilePath || "";
					currentFilePath = filePath;

					if (!filePath) {
						clearFileInfo();
						return;
					}

					// è·å–æ–‡ä»¶åï¼ˆå¤„ç†å¯èƒ½çš„Promiseè¿”å›å€¼ï¼‰
					let fileName = "";
					try {
						const nameResult = bridge.getProxyFileName(filePath);
						if (nameResult instanceof Promise) {
							fileName = await nameResult;
						} else if (typeof nameResult === "string") {
							fileName = nameResult;
						} else {
							console.warn(
								"getProxyFileNameè¿”å›äº†æ„å¤–çš„ç±»å‹:",
								typeof nameResult,
								nameResult
							);
							fileName = "";
						}
					} catch (e) {
						console.error("è·å–æ–‡ä»¶åå¤±è´¥:", e);
						fileName = "";
					}

					// è·å–æ–‡ä»¶å›¾æ ‡ï¼ˆå¤„ç†å¯èƒ½çš„Promiseè¿”å›å€¼ï¼‰
					let fileIcon = "";
					try {
						const iconResult = bridge.getProxyFileIcon(filePath);
						if (iconResult instanceof Promise) {
							fileIcon = await iconResult;
						} else if (typeof iconResult === "string") {
							fileIcon = iconResult;
						} else {
							console.warn(
								"getProxyFileIconè¿”å›äº†æ„å¤–çš„ç±»å‹:",
								typeof iconResult,
								iconResult
							);
							fileIcon = "";
						}
					} catch (e) {
						console.error("è·å–æ–‡ä»¶å›¾æ ‡å¤±è´¥:", e);
						fileIcon = "";
					}

					// è·å–æ–‡ä»¶é¢œè‰²ï¼ˆå¤„ç†å¯èƒ½çš„Promiseè¿”å›å€¼ï¼‰
					let fileColor = "";
					try {
						const colorResult = bridge.getProxyFileColor(filePath);
						if (colorResult instanceof Promise) {
							fileColor = await colorResult;
						} else if (typeof colorResult === "string") {
							fileColor = colorResult;
						} else {
							console.warn(
								"getProxyFileColorè¿”å›äº†æ„å¤–çš„ç±»å‹:",
								typeof colorResult,
								colorResult
							);
							fileColor = "";
						}
					} catch (e) {
						console.error("è·å–æ–‡ä»¶é¢œè‰²å¤±è´¥:", e);
						fileColor = "";
					}

					// æ›´æ–°UI
					document.getElementById("noFile").style.display = "none";
					document.getElementById("fileContent").style.display = "block";

					document.getElementById("fileName").textContent =
						fileName || "æœªçŸ¥æ–‡ä»¶";
					document.getElementById("filePath").textContent = filePath;

					// æ›´æ–°å›¾æ ‡
					const iconElement = document.getElementById("fileIcon");
					if (fileIcon && fileIcon.trim() !== "") {
						iconElement.innerHTML = `<img src="${fileIcon}" alt="æ–‡ä»¶å›¾æ ‡" onerror="this.parentElement.innerHTML='<div class=\\'file-icon-placeholder\\'>ğŸ“„</div>'">`;
					} else {
						iconElement.innerHTML =
							'<div class="file-icon-placeholder">ğŸ“„</div>';
					}

					// æ›´æ–°é¢œè‰²
					if (fileColor && fileColor.trim() !== "") {
						try {
							const colorObj = JSON.parse(fileColor);
							const colorStr = `rgb(${colorObj.r}, ${colorObj.g}, ${colorObj.b})`;
							document.getElementById("fileColor").style.backgroundColor =
								colorStr;
							document.getElementById("fileColor").style.display = "block";
						} catch (e) {
							console.error("è§£ææ–‡ä»¶é¢œè‰²å¤±è´¥:", e);
							document.getElementById("fileColor").style.display = "none";
						}
					} else {
						document.getElementById("fileColor").style.display = "none";
					}

					// å¯ç”¨æŒ‰é’®
					enableButtons(true);
					showStatus("æ–‡ä»¶ä¿¡æ¯å·²æ›´æ–°", "success");
				} catch (error) {
					console.error("æ›´æ–°æ–‡ä»¶ä¿¡æ¯å¤±è´¥:", error);
					showStatus("æ›´æ–°æ–‡ä»¶ä¿¡æ¯å¤±è´¥: " + error.message, "error");
				}
			}

			/**
			 * æ¸…é™¤æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º
			 */
			function clearFileInfo() {
				document.getElementById("noFile").style.display = "block";
				document.getElementById("fileContent").style.display = "none";
				currentFilePath = "";
				enableButtons(false);
			}

			/**
			 * å¯ç”¨/ç¦ç”¨æŒ‰é’®
			 */
			function enableButtons(enabled) {
				document.getElementById("openFileBtn").disabled = !enabled;
				document.getElementById("openLocationBtn").disabled = !enabled;
				document.getElementById("openPropertyBtn").disabled = !enabled;
				document.getElementById("removeFileBtn").disabled = !enabled;
			}

			/**
			 * æ‰“å¼€æ–‡ä»¶
			 */
			function openFile() {
				if (!bridge || !currentFilePath) {
					return;
				}

				try {
					bridge.openProxyFile();
					showStatus("æ­£åœ¨æ‰“å¼€æ–‡ä»¶...", "success");
				} catch (error) {
					console.error("æ‰“å¼€æ–‡ä»¶å¤±è´¥:", error);
					showStatus("æ‰“å¼€æ–‡ä»¶å¤±è´¥: " + error.message, "error");
				}
			}

			/**
			 * æ‰“å¼€æ–‡ä»¶ä½ç½®
			 */
			function openLocation() {
				if (!bridge || !currentFilePath) {
					return;
				}

				try {
					bridge.openProxyFileLocation();
					showStatus("æ­£åœ¨æ‰“å¼€æ–‡ä»¶ä½ç½®...", "success");
				} catch (error) {
					console.error("æ‰“å¼€æ–‡ä»¶ä½ç½®å¤±è´¥:", error);
					showStatus("æ‰“å¼€æ–‡ä»¶ä½ç½®å¤±è´¥: " + error.message, "error");
				}
			}

			/**
			 * æ‰“å¼€æ–‡ä»¶å±æ€§
			 */
			function openProperty() {
				if (!bridge || !currentFilePath) {
					return;
				}

				try {
					bridge.openProxyFileProperty();
					showStatus("æ­£åœ¨æ‰“å¼€æ–‡ä»¶å±æ€§...", "success");
				} catch (error) {
					console.error("æ‰“å¼€æ–‡ä»¶å±æ€§å¤±è´¥:", error);
					showStatus("æ‰“å¼€æ–‡ä»¶å±æ€§å¤±è´¥: " + error.message, "error");
				}
			}

			/**
			 * ç§»é™¤æ–‡ä»¶
			 */
			function removeFile() {
				if (!bridge) {
					return;
				}

				try {
					bridge.removeProxyFile();
					showStatus("æ–‡ä»¶å·²ç§»é™¤", "success");
					clearFileInfo();
				} catch (error) {
					console.error("ç§»é™¤æ–‡ä»¶å¤±è´¥:", error);
					showStatus("ç§»é™¤æ–‡ä»¶å¤±è´¥: " + error.message, "error");
				}
			}

			/**
			 * æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
			 */
			function showStatus(message, type) {
				const statusElement = document.getElementById("status");
				statusElement.textContent = message;
				statusElement.className = "status " + (type || "");

				// 3ç§’åæ¸…é™¤çŠ¶æ€
				setTimeout(function () {
					statusElement.textContent = "";
					statusElement.className = "status";
				}, 3000);
			}

			// é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
			window.addEventListener("load", function () {
				console.log("ProxyFileæ¼”ç¤ºé¡µé¢åŠ è½½å®Œæˆ");
			});
		</script>
	</body>
</html>
