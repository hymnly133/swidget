<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>HTMLæ¨¡æ¿</title>
		<script src="qrc:///qtwebchannel/qwebchannel.js"></script>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				width: 100vw;
				height: 100vh;
				overflow: hidden;
				background: transparent;
				font-family: "Microsoft YaHei", "Segoe UI", Arial, sans-serif;
				display: flex;
				align-items: center;
				justify-content: center;
				color: #ffffff;
			}

			.container {
				width: 100%;
				height: 100%;
				padding: 20px;
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				gap: 15px;
			}

			.info-section {
				display: flex;
				flex-direction: column;
				gap: 10px;
				align-items: center;
			}

			.info-item {
				font-size: 16px;
				padding: 5px 0;
			}

			.info-label {
				font-weight: bold;
				margin-right: 8px;
			}

			.info-value {
				color: #a0a0a0;
			}

			.theme-color {
				color: var(--theme-color, #007acc);
			}

			.button-group {
				display: flex;
				flex-direction: column;
				gap: 10px;
				margin-top: 10px;
			}

			button {
				padding: 10px 20px;
				background: rgba(255, 255, 255, 0.1);
				color: #ffffff;
				border: 1px solid rgba(255, 255, 255, 0.2);
				border-radius: 6px;
				cursor: pointer;
				font-size: 14px;
				transition: all 0.3s;
			}

			button:hover {
				background: rgba(255, 255, 255, 0.2);
				border-color: rgba(255, 255, 255, 0.3);
			}

			button:active {
				transform: scale(0.98);
			}

			.input-section {
				display: flex;
				flex-direction: column;
				gap: 10px;
				align-items: center;
				margin-top: 20px;
				width: 100%;
				max-width: 400px;
			}

			.input-label {
				font-size: 14px;
				font-weight: bold;
				color: #ffffff;
			}

			.persistent-input {
				width: 100%;
				padding: 10px 15px;
				background: rgba(255, 255, 255, 0.1);
				color: #ffffff;
				border: 1px solid rgba(255, 255, 255, 0.2);
				border-radius: 6px;
				font-size: 14px;
				font-family: "Microsoft YaHei", "Segoe UI", Arial, sans-serif;
				transition: all 0.3s;
			}

			.persistent-input:focus {
				outline: none;
				border-color: var(--theme-color, #007acc);
				background: rgba(255, 255, 255, 0.15);
			}

			.persistent-input::placeholder {
				color: rgba(255, 255, 255, 0.5);
			}

			.input-hint {
				font-size: 12px;
				color: #a0a0a0;
				text-align: center;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="info-section">
				<div class="info-item">
					<span class="info-label">themeColor:</span>
					<span class="info-value theme-color" id="themeColor">-</span>
				</div>
				<div class="info-item">
					<span class="info-label">smtc:</span>
					<span class="info-value" id="smtcEnabled">-</span>
				</div>
				<div class="info-item">
					<span class="info-label">widgetName:</span>
					<span class="info-value" id="widgetName">-</span>
				</div>
				<div class="info-item">
					<span class="info-label">isFocus:</span>
					<span class="info-value" id="isFocus">-</span>
				</div>
			</div>

			<div class="input-section">
				<label class="input-label" for="persistentTextInput"
					>æŒä¹…åŒ–æ–‡æœ¬ï¼ˆç¤ºä¾‹ï¼‰</label
				>
				<input
					type="text"
					id="persistentTextInput"
					class="persistent-input"
					placeholder="è¾“å…¥æ–‡æœ¬ï¼Œå…³é—­åé‡æ–°æ‰“å¼€ä¼šä¿ç•™..."
					oninput="onPersistentTextChanged(this.value)"
				/>
				<div class="input-hint">æ­¤æ–‡æœ¬ä¼šè‡ªåŠ¨ä¿å­˜ï¼Œé‡æ–°åŠ è½½å°ç»„ä»¶åä¼šæ¢å¤</div>
			</div>

			<div class="button-group">
				<button onclick="refreshInfo()">åˆ·æ–°ä¿¡æ¯</button>
				<button onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
			</div>
		</div>

		<script>
			// WebChannelå’Œbridgeå¯¹è±¡
			let bridge = null;
			// æŒä¹…åŒ–æ–‡æœ¬å±æ€§å
			const PERSISTENT_TEXT_PROPERTY = "persistentText";

			// åˆå§‹åŒ–WebChannel
			function initWebChannel() {
				if (typeof qt === "undefined" || !qt.webChannelTransport) {
					console.error("é”™è¯¯: qt.webChannelTransport ä¸å¯ç”¨");
					return;
				}

				new QWebChannel(qt.webChannelTransport, function (channel) {
					bridge = channel.objects.bridge;

					if (!bridge) {
						console.error("é”™è¯¯: bridgeå¯¹è±¡æœªæ‰¾åˆ°");
						return;
					}

					console.log("âœ… WebChannelåˆå§‹åŒ–æˆåŠŸ");

					// è¿æ¥å“åº”å¼å±æ€§å˜åŒ–ä¿¡å·
					if (bridge.unitInfoChanged) {
						bridge.unitInfoChanged.connect(function () {
							console.log("ğŸ”„ å°ç»„ä»¶åŸºç¡€ä¿¡æ¯å·²æ›´æ–°ï¼ˆå“åº”å¼ï¼‰");
							updateUnitInfo();
						});
					}

					if (bridge.smtcMediaInfoChanged) {
						bridge.smtcMediaInfoChanged.connect(function () {
							console.log("ğŸ”„ SMTCåª’ä½“ä¿¡æ¯å·²æ›´æ–°ï¼ˆå“åº”å¼ï¼‰");
							updateSMTCStatus();
						});
					}

					// è¿æ¥æŒä¹…åŒ–å±æ€§åŠ è½½å®Œæˆä¿¡å·
					if (bridge.persistentPropertyLoaded) {
						bridge.persistentPropertyLoaded.connect(function (name, value) {
							console.log("ğŸ“¦ æŒä¹…åŒ–å±æ€§å·²åŠ è½½:", name, value);
							onPersistentPropertyLoaded(name, value);
						});
					}

					// åˆå§‹åŒ–æ•°æ®
					init();
				});
			}

			// åˆå§‹åŒ–
			async function init() {
				// æ³¨å†ŒæŒä¹…åŒ–å±æ€§ï¼ˆåœ¨é¡µé¢åŠ è½½æ—¶è°ƒç”¨ï¼‰
				if (bridge.registerPersistentProperty) {
					try {
						// æ³¨å†ŒæŒä¹…åŒ–æ–‡æœ¬å±æ€§ï¼Œé»˜è®¤å€¼ä¸ºç©ºå­—ç¬¦ä¸²
						bridge.registerPersistentProperty(
							PERSISTENT_TEXT_PROPERTY,
							JSON.stringify("")
						);
						console.log("âœ… æŒä¹…åŒ–å±æ€§å·²æ³¨å†Œ:", PERSISTENT_TEXT_PROPERTY);
					} catch (e) {
						console.error("æ³¨å†ŒæŒä¹…åŒ–å±æ€§å¤±è´¥:", e);
					}
				}

				// è·å–ä¸»é¢˜è‰²
				if (bridge.getThemeColor) {
					try {
						const color = await bridge.getThemeColor();
						if (color) {
							document.documentElement.style.setProperty(
								"--theme-color",
								color
							);
							updateThemeColor(color);
						}
					} catch (e) {
						console.error("è·å–ä¸»é¢˜è‰²å¤±è´¥:", e);
					}
				}

				// æ›´æ–°ä¿¡æ¯
				refreshInfo();
			}

			// åˆ·æ–°ä¿¡æ¯
			function refreshInfo() {
				updateUnitInfo();
				updateSMTCStatus();
			}

			// æ›´æ–°Unitä¿¡æ¯
			function updateUnitInfo() {
				if (!bridge || !bridge.unitInfo) {
					return;
				}

				try {
					const info = JSON.parse(bridge.unitInfo);
					document.getElementById("widgetName").textContent =
						info.widgetName || "-";
					document.getElementById("isFocus").textContent = info.isFocus
						? "æ˜¯"
						: "å¦";
				} catch (e) {
					console.error("è§£æUnitä¿¡æ¯å¤±è´¥:", e);
				}
			}

			// æ›´æ–°ä¸»é¢˜è‰²æ˜¾ç¤º
			function updateThemeColor(color) {
				document.getElementById("themeColor").textContent = color;
			}

			// æ›´æ–°SMTCçŠ¶æ€
			function updateSMTCStatus() {
				if (!bridge || !bridge.smtcMediaInfo) {
					document.getElementById("smtcEnabled").textContent = "æœªå¯ç”¨";
					document.getElementById("smtcEnabled").style.color = "#f44336";
					return;
				}

				try {
					const smtcInfo = JSON.parse(bridge.smtcMediaInfo);
					const enabled = smtcInfo.enabled || false;
					const statusElement = document.getElementById("smtcEnabled");
					statusElement.textContent = enabled ? "å·²å¯ç”¨" : "æœªå¯ç”¨";
					statusElement.style.color = enabled ? "#4caf50" : "#f44336";
				} catch (e) {
					document.getElementById("smtcEnabled").textContent = "æœªå¯ç”¨";
					document.getElementById("smtcEnabled").style.color = "#f44336";
				}
			}

			// æŒä¹…åŒ–æ–‡æœ¬è¾“å…¥æ¡†å€¼å˜åŒ–å¤„ç†
			function onPersistentTextChanged(value) {
				if (!bridge || !bridge.setPersistentProperty) {
					console.warn("bridgeæˆ–setPersistentPropertyæ–¹æ³•ä¸å¯ç”¨");
					return;
				}

				try {
					// è®¾ç½®æŒä¹…åŒ–å±æ€§å€¼
					bridge.setPersistentProperty(
						PERSISTENT_TEXT_PROPERTY,
						JSON.stringify(value)
					);
					console.log("ğŸ’¾ æŒä¹…åŒ–æ–‡æœ¬å·²ä¿å­˜:", value);
				} catch (e) {
					console.error("è®¾ç½®æŒä¹…åŒ–å±æ€§å¤±è´¥:", e);
				}
			}

			// æŒä¹…åŒ–å±æ€§åŠ è½½å®Œæˆå¤„ç†
			function onPersistentPropertyLoaded(name, value) {
				if (name === PERSISTENT_TEXT_PROPERTY) {
					try {
						const textValue = JSON.parse(value);
						const inputElement = document.getElementById("persistentTextInput");
						if (inputElement) {
							inputElement.value = textValue;
							console.log("ğŸ“¥ æŒä¹…åŒ–æ–‡æœ¬å·²æ¢å¤:", textValue);
						}
					} catch (e) {
						console.error("è§£ææŒä¹…åŒ–å±æ€§å€¼å¤±è´¥:", e);
					}
				}
			}

			// æµ‹è¯•è¿æ¥
			function testConnection() {
				if (!bridge) {
					console.error("bridgeå¯¹è±¡æœªåˆå§‹åŒ–");
					alert("bridgeå¯¹è±¡æœªåˆå§‹åŒ–");
					return;
				}

				if (bridge.getCurrentTime) {
					bridge.getCurrentTime(function (time) {
						console.log("å½“å‰æ—¶é—´:", time);
						alert("è¿æ¥æ­£å¸¸ï¼\nå½“å‰æ—¶é—´: " + time);
					});
				} else {
					alert("è¿æ¥æ­£å¸¸ï¼Œä½†getCurrentTimeæ–¹æ³•ä¸å¯ç”¨");
				}
			}

			// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–WebChannel
			window.addEventListener("DOMContentLoaded", function () {
				console.log("é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–WebChannel...");
				// å»¶è¿Ÿä¸€ä¸‹ç¡®ä¿qtå¯¹è±¡å·²å‡†å¤‡å¥½
				setTimeout(initWebChannel, 100);
			});
		</script>
	</body>
</html>
